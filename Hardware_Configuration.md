# 电梯控制系统硬件配置文档

## 1. Master MCU (STM32F407VET6) 硬件配置

### 1.1 系统时钟
- HSE: 8MHz 外部晶振
- 系统时钟: 168MHz (通过PLL)

### 1.2 UART配置
#### UART5 (RS485通信)
- **TX**: PC12
- **RX**: PD2
- **波特率**: 115200
- **数据位**: 8
- **停止位**: 1
- **校验**: 无
- **硬件流控**: 无
- **DMA**: 
  - TX: DMA1_Stream7
  - RX: DMA1_Stream0

### 1.3 步进电机控制引脚
- **STEP**: PE9 (TIM1_CH1)
- **DIR**: PE8
- **ENABLE**: PE10
- **PWM频率**: 可调 (1Hz - 10kHz)

### 1.4 按钮输入 (外呼按钮)
- **BTN_UP_1** (1楼上行): PD0
- **BTN_UP_2** (2楼上行): PD1  
- **BTN_DOWN_2** (2楼下行): PD3
- **BTN_DOWN_3** (3楼下行): PD4
- 所有按钮配置为GPIO_INPUT，内部上拉

### 1.5 OLED显示 (I2C)
- **SCL**: PB6 (I2C1_SCL)
- **SDA**: PB7 (I2C1_SDA)
- **地址**: 0x78
- **分辨率**: 128x64

### 1.6 调试串口
- **USART1**: 用于printf调试输出
  - TX: PA9
  - RX: PA10
  - 波特率: 115200

### 1.7 CAN总线 (未使用)
- **CAN1_RX**: PD0
- **CAN1_TX**: PD1

---

## 2. Slave MCU (STM32F103C8T6) 硬件配置

### 2.1 系统时钟
- HSE: 8MHz 外部晶振
- 系统时钟: 72MHz (通过PLL)

### 2.2 UART配置
#### USART2 (RS485通信)
- **TX**: PA2
- **RX**: PA3
- **波特率**: 115200
- **数据位**: 8
- **停止位**: 1
- **校验**: 无
- **硬件流控**: 无
- **DMA**:
  - TX: DMA1_Channel7
  - RX: DMA1_Channel6

### 2.3 键盘输入 (内呼按钮)
- **键盘中断线**: PA11 (EXTI11) - 下降沿触发
- **S16** (1楼内呼): PA4
- **S15** (2楼内呼): PA8  
- **S14** (3楼内呼): PA5
- **S13** (未使用): PA12
- 键盘扫描通过PA11中断触发，然后读取各按键状态

### 2.4 光电传感器
- **输入引脚**: PB5 (EXTI5)
- **触发方式**: 下降沿 (FALLING)
- **类型**: NPN型光电传感器
- **功能**: 检测电梯到达楼层位置

### 2.5 舵机控制 (门控系统)
- **PWM输出**: PA0 (TIM2_CH1)
- **PWM频率**: 50Hz
- **脉宽范围**: 0.5ms - 2.5ms
- **UART通信**: USART1 (与舵机驱动器通信)
  - TX: PA9
  - RX: PA10
  - 波特率: 115200

### 2.6 LED指示灯
- **LED1**: PC13 (板载LED)
- **LED2**: PB12
- **LED3**: PB13
- **LED4**: PB14

### 2.7 调试串口
- **USART1**: 用于printf调试输出
  - TX: PA9
  - RX: PA10
  - 波特率: 115200

### 2.8 门控开关 (未实装)
- **DOOR_OPEN_BTN**: 未连接
- **DOOR_CLOSE_BTN**: 未连接

---

## 3. RS485通信硬件连接

### 3.1 物理连接
```
Master MCU (UART5)          Slave MCU (USART2)
    PC12 (TX) ----[RS485]---- PA3 (RX)
    PD2 (RX)  ----[RS485]---- PA2 (TX)
    GND       ---------------- GND
```

### 3.2 RS485收发器配置
- **芯片型号**: MAX485 或兼容芯片
- **DE/RE控制**: 
  - Master: 可能需要额外GPIO控制
  - Slave: 可能需要额外GPIO控制
- **终端电阻**: 120Ω (在总线两端)

### 3.3 通信协议
- **物理层**: RS485半双工
- **波特率**: 115200 bps
- **数据格式**: 8-N-1
- **包格式**: 4字节定长包
  - Byte 0: 命令码
  - Byte 1-3: 数据

---

## 4. 中断优先级配置

### Master MCU
- **EXTI中断** (按钮): 优先级2
- **TIM1** (步进电机PWM): 优先级1
- **UART5** (RS485): 优先级2
- **DMA1**: 优先级3

### Slave MCU
- **EXTI11** (键盘): 优先级2
- **EXTI5** (光电传感器): 优先级1
- **USART2** (RS485): 优先级2
- **TIM2** (舵机PWM): 优先级3
- **DMA1**: 优先级3

---

## 5. 功能模块映射

### Master MCU功能
1. **电梯主控制逻辑** (FSM状态机)
2. **SCAN调度算法**
3. **步进电机控制** (电梯升降)
4. **外呼按钮处理**
5. **OLED显示** (楼层、方向、状态)
6. **RS485主机通信**

### Slave MCU功能
1. **内呼按钮处理** (键盘扫描)
2. **光电传感器检测** (楼层位置)
3. **门控系统** (舵机控制)
4. **LED状态指示**
5. **RS485从机通信**
6. **本地事件管理** (Local Blackboard)

---

## 6. 注意事项

### 6.1 硬件注意事项
- RS485需要共地连接
- RS485 A/B线不能接反
- 光电传感器需要适当的上拉电阻
- 步进电机驱动器需要独立供电

### 6.2 软件注意事项
- DMA传输需要正确配置循环模式
- UART空闲中断需要手动清除标志
- 按键需要软件消抖处理
- RS485半双工通信需要控制收发切换

### 6.3 当前已知问题
- RS485 DMA接收可能存在问题
- 需要确认RS485收发器DE/RE引脚控制
- 门控按钮硬件未实装

---

## 7. CubeMX重新生成注意事项

### 需要保留的配置
1. 所有GPIO引脚分配
2. 定时器通道分配
3. 中断优先级设置
4. DMA通道分配

### 可能需要修改的配置
1. RS485相关的UART配置
2. DMA循环模式设置
3. RS485收发器控制引脚
4. UART中断使能设置

### 重新生成后需要恢复的代码
1. 所有Modules目录下的业务代码
2. main.c中的用户代码段
3. 中断处理函数中的用户代码
4. printf重定向代码

---

## 8. 测试检查清单

### RS485通信测试
- [ ] 物理连接正确 (A-A, B-B, GND-GND)
- [ ] 波特率匹配 (115200)
- [ ] DMA配置正确
- [ ] 中断使能正确
- [ ] DE/RE控制正确 (如果有)

### 功能模块测试
- [ ] 步进电机响应正确
- [ ] 按钮输入正常
- [ ] 键盘扫描正常
- [ ] 光电传感器触发正常
- [ ] OLED显示正常
- [ ] LED指示正常

---

更新日期: 2025-01-18
版本: 1.0