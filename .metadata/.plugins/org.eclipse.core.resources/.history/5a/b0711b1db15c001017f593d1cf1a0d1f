#include "can.h"

/* HAL 生成的全局句柄在 main.c 中，这里用 extern 引用 */
extern CAN_HandleTypeDef hcan1;

/* ------------ 使能 FIFO0 全接收过滤器并启动 CAN ------------ */
void CAN1_UserFilterStart(void)
{
    CAN_FilterTypeDef f = {0};

    f.FilterBank           = 0;                      /* F407 单 CAN：0~13 */
    f.FilterMode           = CAN_FILTERMODE_IDMASK;  /* 掩码 */
    f.FilterScale          = CAN_FILTERSCALE_32BIT;
    f.FilterIdHigh         = 0x0000;
    f.FilterIdLow          = 0x0000;
    f.FilterMaskIdHigh     = 0x0000;
    f.FilterMaskIdLow      = 0x0000;
    f.FilterFIFOAssignment = CAN_RX_FIFO0;
    f.FilterActivation     = ENABLE;

    HAL_CAN_ConfigFilter(&hcan1, &f);
    HAL_CAN_Start(&hcan1);
}

/* -------------------- 发送 7 字节标准数据帧 -------------------- */
uint8_t CAN1_Send_Num(uint16_t std_id, const uint8_t *data)
{
    CAN_TxHeaderTypeDef tx = {0};
    uint32_t mailbox;

    tx.StdId  = std_id;          /* 11 位 ID */
    tx.IDE    = CAN_ID_STD;
    tx.RTR    = CAN_RTR_DATA;
    tx.DLC    = 7;               /* 数据长度固定 7 字节 */

    return (HAL_CAN_AddTxMessage(&hcan1, &tx, (uint8_t *)data, &mailbox) == HAL_OK) ? 0 : 1;
}


