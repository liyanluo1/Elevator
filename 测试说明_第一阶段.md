# 电梯系统第一阶段测试说明

## 测试配置
- **门控模块**：禁用（使用2秒延时模拟）
- **光电传感器**：启用（用于楼层检测和中途停靠）
- **SCAN算法**：完整版（包含中途停靠）

## 系统初始条件
1. 电梯必须在**1楼**
2. 光电传感器必须**被触发**（BLOCKED状态）
3. 系统启动后自动设置当前楼层为1

## 主要功能修改

### 1. 中途停靠逻辑（新增）
- 光电传感器触发时检查是否有同方向呼叫
- 如果有，停靠2秒后继续
- 示例：1楼→3楼，经过2楼时如果2楼有上行呼叫，会停靠

### 2. 位置误差检测（新增）
- 每次光电触发时检测位置误差
- 误差 < 1000步：正常
- 误差 1000-3000步：打印警告
- 误差 > 3000步：严重警告（可选停机）

### 3. 超时保护（新增）
- 运动时间超过预期时自动停止
- 预期时间 = 楼层差 * 5秒 + 5秒

### 4. 简化的功能
- 移除了位置预判逻辑
- 移除了动态速度调整
- 移除了复杂的校准算法

## 测试用例

### 测试1：基本运行
1. 按下2UP（2楼上行外呼）
2. 验证：电梯从1楼→2楼
3. 等待2秒（模拟开关门）
4. 系统回到IDLE

### 测试2：多楼层呼叫
1. 按下3DN（3楼下行外呼）
2. 立即按S15（Slave键盘，2楼内呼）
3. 验证顺序：
   - 1楼→2楼（中途停靠，2秒）
   - 2楼→3楼（最终目标，2秒）

### 测试3：中途停靠测试
1. 按下3DN（3楼下行外呼）
2. 电梯开始移动后，快速按2UP
3. 验证：经过2楼时是否停靠

### 测试4：光电传感器测试
1. 运行中手动触发光电传感器
2. 验证：系统正确识别楼层
3. 检查串口输出的位置误差

### 测试5：超时测试
1. 断开步进电机连接
2. 按下3DN
3. 验证：约15秒后系统超时停止

## 调试输出说明

### Master MCU (OLED显示)
```
F1 IDLE      - 当前楼层和状态
C:2 RX:3     - 内呼楼层和接收计数
H:3          - 外呼楼层
485RX:10     - RS485总接收计数
```

### Slave MCU (串口输出)
```
[KEYBOARD] - 键盘按键事件
[PHOTO]    - 光电传感器事件
[RS485 TX] - 发送内呼/光电信号
[STATUS]   - 每5秒状态报告
```

### Master MCU (串口输出)
```
[FSM]      - 状态机转换
[PHOTO]    - 光电事件处理
[MOTOR]    - 电机控制命令
[WARNING]  - 位置误差警告
```

## 注意事项
1. 确保初始在1楼，光电被触发
2. 步进电机每层10800步
3. 中途停靠会延长总运行时间
4. 位置误差是累积的，运行越久误差越大

## 已知限制
1. 没有编码器闭环控制
2. 光电传感器失效会导致楼层错位
3. 门控模块禁用，只有固定延时