#include "can.h"

/* extern 句柄由 main.c/ CubeMX 提供 */
extern CAN_HandleTypeDef hcan1;

/* 启动 CAN + 过滤器：全接收到 FIFO0 */
void CAN1_UserFilterStart(void)
{
    CAN_FilterTypeDef f = {0};
    f.FilterBank           = 0;
    f.FilterMode           = CAN_FILTERMODE_IDMASK;
    f.FilterScale          = CAN_FILTERSCALE_32BIT;
    f.FilterIdHigh         = 0x0000;
    f.FilterIdLow          = 0x0000;
    f.FilterMaskIdHigh     = 0x0000;
    f.FilterMaskIdLow      = 0x0000;
    f.FilterFIFOAssignment = CAN_RX_FIFO0;
    f.FilterActivation     = ENABLE;

    // 配置过滤器
    if (HAL_CAN_ConfigFilter(&hcan1, &f) != HAL_OK) {
        Error_Handler();
    }

    // 启动CAN - 这一步很重要！
    if (HAL_CAN_Start(&hcan1) != HAL_OK) {
        Error_Handler();
    }
}

/* 发送 7-byte 标准数据帧 */
uint8_t CAN1_Send_Num(uint16_t std_id, const uint8_t *data)
{
    CAN_TxHeaderTypeDef tx = {0};
    uint32_t mailbox;

    tx.StdId  = std_id & 0x7FF;
    tx.IDE    = CAN_ID_STD;
    tx.RTR    = CAN_RTR_DATA;
    tx.DLC    = 8;  // 改为8字节

    return (HAL_CAN_AddTxMessage(&hcan1, &tx, (uint8_t*)data, &mailbox) == HAL_OK) ? 0 : 1;
}


