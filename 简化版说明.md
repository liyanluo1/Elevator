# 简化版电梯控制系统 - 步进电机 + 光电传感器

## 系统概述
这是一个极简的电梯控制系统，仅使用步进电机和光电传感器实现精确的楼层定位。

## 核心思路

### 1. 初始位置处理
- 系统启动时，假设电梯在**1楼**（手动放置）
- 读取步进电机当前位置作为1楼的参考点
- 根据此参考点计算2楼、3楼的理论位置：
  - 1楼 = 当前位置
  - 2楼 = 1楼 + 10800步
  - 3楼 = 1楼 + 21600步

### 2. 光电传感器校正
- **第一次触发**：校准系统
  - 根据光电传感器确认的实际楼层重新计算偏移量
  - 更新所有楼层的绝对位置
  
- **后续触发**：验证和微调
  - 比较实际位置与理论位置的误差
  - 如果误差 > 100步，自动调整偏移量

### 3. 工作流程
```
启动 → 读取电机位置 → 假设在1楼 → 移动到目标楼层
         ↓
    光电传感器触发
         ↓
    校正实际楼层位置
         ↓
    继续/调整移动
```

## 文件说明

### 主控MCU (STM32F4)
- `mastermcu/Core/Src/main_simple.c` - 简化版主程序
  - 步进电机控制
  - 位置计算和校正
  - RS485通信接收光电传感器数据

### 从控MCU (STM32F1)  
- `slavemcu/Core/Src/main_simple.c` - 简化版从程序
  - 光电传感器检测
  - RS485发送楼层信息

## 关键参数
- `STEPS_PER_FLOOR = 10800` - 每层楼的步数
- `MAX_FLOORS = 3` - 总楼层数
- 光电传感器防抖时间：500ms
- 位置误差阈值：100步

## 测试步骤

1. **编译和下载程序**
   - 编译 `main_simple.c` 而不是 `main.c`
   - 分别下载到主控和从控MCU

2. **系统启动**
   - 手动将电梯放在1楼（位置可以有偏差）
   - 系统自动读取位置并开始移动

3. **自动校准**
   - 第一次经过光电传感器时自动校准
   - 系统会自动调整并继续到目标楼层

4. **循环测试**
   - 程序会自动循环测试：1楼→2楼→3楼→1楼...
   - 每次到达目标楼层后等待3秒

## 优势
1. **无需复杂校准**：启动即可使用
2. **自动纠偏**：光电传感器持续校正位置
3. **容错性强**：即使初始位置有偏差也能正常工作
4. **代码简洁**：易于理解和维护

## 注意事项
1. 确保电梯启动时确实在1楼附近
2. 光电传感器应该在每层楼的固定位置
3. RS485通信要正常工作
4. 步进电机驱动器要正确配置